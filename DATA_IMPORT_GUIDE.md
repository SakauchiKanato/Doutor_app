# 過去データCSVインポート機能 実装完了

## 実装内容

HENKOU.mdの改善3に基づき、過去データのCSVインポート機能を実装しました。

---

## 新規追加ファイル

### 1. [forecast_import.php](file:///Users/sakauchikanato/ishibashiken/asobi/Doutor_app/forecast_import.php)
過去の発注データをCSVから一括インポート

**機能**:
- ✅ 柔軟なカラムマッピング（商品登録と同様）
- ✅ 自動カラム検出（「日付」「商品名」「星ランク」など）
- ✅ 商品名→item_idの自動変換
- ✅ データ検証（日付形式、数値範囲、商品存在確認）
- ✅ 重複データ処理（スキップ or 上書き更新）

**必須カラム**:
- 対象日
- 商品名
- 星ランク（1〜5）
- 予測消費量

**オプションカラム**:
- 実際の消費量
- 残在庫
- 発注量

**CSVサンプル**:
```csv
日付,商品名,星ランク,予測消費量,実際の消費量,残在庫
2026-01-15,ブレンドコーヒー豆,3,10,12,5
2026-01-16,ホイップクリーム,4,15,14,8
```

### 2. [actual_import.php](file:///Users/sakauchikanato/ishibashiken/asobi/Doutor_app/actual_import.php)
過去の実績消費データをCSVから一括インポート

**機能**:
- ✅ 柔軟なカラムマッピング
- ✅ 自動カラム検出
- ✅ 商品名→item_idの自動変換
- ✅ データ検証
- ✅ 重複データは自動上書き更新

**必須カラム**:
- 記録日
- 商品名
- 消費量

**オプションカラム**:
- 残在庫
- 備考

**CSVサンプル**:
```csv
日付,商品名,消費量,残在庫,備考
2026-01-15,ブレンドコーヒー豆,12,5,イベント日
2026-01-16,ホイップクリーム,14,8,通常営業
```

### 3. [data_import.php](file:///Users/sakauchikanato/ishibashiken/asobi/Doutor_app/data_import.php)
データインポートのランディングページ

---

## 更新ファイル

### [includes/header.php](file:///Users/sakauchikanato/ishibashiken/asobi/Doutor_app/includes/header.php)
- 管理者メニューに「📥 データインポート」を追加

---

## 使い方

### 発注データのインポート

1. 管理者でログイン
2. 「📥 データインポート」→「発注データをインポート」をクリック
3. CSVファイルをアップロード
4. カラムマッピング画面でカラムの対応を設定
5. 重複データの処理方法を選択（スキップ or 上書き）
6. 「インポート実行」をクリック

### 実績データのインポート

1. 管理者でログイン
2. 「📥 データインポート」→「実績データをインポート」をクリック
3. CSVファイルをアップロード
4. カラムマッピング画面でカラムの対応を設定
5. 「インポート実行」をクリック

---

## 特徴

### 1. 柔軟なCSVフォーマット対応
- **どんなカラム名でもOK**: 「日付」「Date」「対象日」など様々な表現に対応
- **カラム順序自由**: カラムの順番は問いません
- **自動検出**: キーワードを元に自動的にマッピングを提案

### 2. 商品名の自動変換
- CSV内の商品名を自動的にitem_idに変換
- 商品が見つからない場合はエラー表示

### 3. データ検証
- ✅ 日付形式チェック（YYYY-MM-DD or YYYY/MM/DD）
- ✅ 星ランク範囲チェック（1〜5）
- ✅ 数値範囲チェック（0以上）
- ✅ 商品存在確認

### 4. エラーハンドリング
- エラー行を明示して表示
- エラーがあっても可能な分はインポート
- エラー詳細を最大10件表示

### 5. 重複データ処理
- **発注データ**: スキップ or 上書き更新を選択可能
- **実績データ**: 自動的に上書き更新

---

## ML/AI分析への活用

インポートした過去データは以下で活用されます:

1. **Python ML予測スクリプト** (`ml/predict_inventory.py`)
   - 過去60日のデータを学習
   - 星ランク別・ジャンル別の補正係数を計算

2. **Gemini AI分析** (`ai_analysis.php`)
   - 過去データから傾向を分析
   - 改善提案を生成

---

## 次のステップ

データインポート後:
1. 「🤖 AI分析」で在庫分析を実行
2. ML予測スクリプトで発注推奨量を算出
3. 予測精度を確認・改善

---

**実装日**: 2026年2月11日  
**ステータス**: ✅ 実装完了
